<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bambam Delivery</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#E3342F', // Rojo para acentos (Bambam)
                        'secondary': '#F6AD55', // Naranja para botones de acci√≥n
                        'bg-main': '#F7F7F7', // Fondo principal claro
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados */
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 1rem;
            transition: transform 0.3s ease;
        }
        .btn-primary {
            background-color: #E3342F;
            border: none;
        }
        .btn-primary:hover {
            background-color: #CC2C28;
        }
        .input-field {
            border: 1px solid #D2D6DC;
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        .view-section {
            display: none;
        }
    </style>
</head>
<body class="bg-bg-main min-h-screen flex flex-col items-center p-4 font-sans">

    <!-- Header y Navegaci√≥n Principal -->
    <header class="w-full max-w-4xl mb-8 sticky top-0 bg-bg-main z-10">
        <div class="flex justify-between items-center py-4 px-2">
            <h1 class="text-3xl font-bold text-primary cursor-pointer" onclick="navigate('home')">Bambam üõµ Delivery</h1>
            <div class="flex items-center space-x-4">
                <button id="cart-btn" class="bg-secondary text-gray-800 p-2 rounded-full shadow-lg hover:bg-yellow-400 transition hidden" onclick="navigate('cart')">
                    üõí <span id="cart-count" class="text-sm font-bold">0</span>
                </button>
                <button id="logout-btn" class="text-gray-600 hover:text-primary transition hidden" onclick="signOutUser()">
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>
    </header>

    <main class="w-full max-w-4xl">
        <!-- VISTA DE MENSAJES DE ERROR/√âXITO -->
        <div id="app-message-box" class="hidden p-4 mb-4 text-sm font-medium rounded-lg" role="alert"></div>

        <!-- 1. VISTA DE AUTENTICACI√ìN / REGISTRO (auth-view) -->
        <div id="auth-view" class="view-section flex justify-center">
            <div class="bg-white p-8 card w-full max-w-md">
                <h2 id="auth-title" class="text-2xl font-semibold mb-6 text-gray-800">Iniciar Sesi√≥n</h2>
                
                <input type="email" id="auth-email" placeholder="Correo Electr√≥nico" class="input-field mb-4">
                <input type="password" id="auth-password" placeholder="Contrase√±a" class="input-field mb-6">

                <!-- Campos de Registro Adicionales (Ocultos inicialmente) -->
                <div id="register-fields" class="hidden">
                    <input type="text" id="reg-name" placeholder="Nombre" class="input-field mb-4">
                    <input type="text" id="reg-lastname" placeholder="Apellido" class="input-field mb-4">
                    <input type="date" id="reg-dob" placeholder="Fecha de Nacimiento" class="input-field mb-4 text-gray-500">
                    <input type="tel" id="reg-phone" placeholder="N√∫mero de Tel√©fono" class="input-field mb-6">
                </div>
                
                <button id="auth-btn" class="w-full btn-primary text-white py-3 font-semibold rounded-xl transition duration-150" onclick="handleAuth()">
                    Iniciar Sesi√≥n
                </button>
                
                <div class="mt-6 text-center">
                    <a href="#" id="toggle-register" class="text-primary hover:text-red-700 text-sm font-medium">¬øNo tienes cuenta? Reg√≠strate</a>
                </div>
            </div>
        </div>

        <!-- 2. VISTA DE USUARIO (home-view) -->
        <div id="home-view" class="view-section">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Locales Activos Cerca de Ti</h2>
            
            <!-- Bot√≥n para registrar negocio -->
            <button class="w-full bg-green-500 text-white py-3 font-semibold rounded-xl transition duration-150 hover:bg-green-600 mb-6" onclick="window.open('https://wa.me/584128481584', '_blank')">
                Quiero Registrar Mi Negocio ü§ù
            </button>

            <!-- Lista de Locales -->
            <div id="stores-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- 3. VISTA DE MEN√ö DEL LOCAL (menu-view) -->
        <div id="menu-view" class="view-section">
            <button class="text-primary mb-4 font-medium hover:underline" onclick="navigate('home')">&larr; Volver a Locales</button>
            <h2 id="menu-title" class="text-3xl font-bold mb-6 text-gray-800">Men√∫ del Local</h2>
            <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Se llenar√° din√°micamente -->
            </div>
        </div>

        <!-- 4. VISTA DEL CARRITO (cart-view) -->
        <div id="cart-view" class="view-section max-w-xl mx-auto">
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Tu Pedido</h2>
            <div id="cart-items-container" class="bg-white p-6 card mb-6">
                <!-- √çtems del carrito se insertan aqu√≠ -->
                <p id="empty-cart-message" class="text-gray-500 text-center">Tu carrito est√° vac√≠o.</p>
            </div>

            <div id="cart-summary" class="bg-gray-100 p-4 rounded-xl mb-6">
                <p class="text-xl font-bold text-gray-800">Total: <span id="cart-total-price">Bs. 0.00</span></p>
            </div>

            <h3 class="text-xl font-semibold mb-4 text-gray-700">Detalles de Entrega</h3>
            <div class="bg-white p-6 card mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="checkout-name" placeholder="Nombre" class="input-field">
                <input type="text" id="checkout-lastname" placeholder="Apellido" class="input-field">
                <input type="text" id="checkout-address" placeholder="Direcci√≥n de Entrega Detallada" class="input-field col-span-full">
                <input type="tel" id="checkout-phone" placeholder="N√∫mero de Tel√©fono" class="input-field">
            </div>

            <button id="place-order-btn" class="w-full btn-primary text-white py-3 font-semibold rounded-xl transition duration-150" onclick="placeOrder()">
                Realizar Pedido
            </button>
        </div>

        <!-- 5. PANEL DE ADMINISTRACI√ìN (admin-view) -->
        <div id="admin-view" class="view-section">
            <h2 class="text-3xl font-bold mb-6 text-primary border-b pb-2">Panel de Administraci√≥n</h2>
            <div id="admin-tabs" class="flex border-b mb-6 space-x-4">
                <button class="admin-tab-btn p-2 hover:bg-gray-200 rounded-t-lg font-medium border-b-2 border-transparent text-gray-600" data-tab="stores">Gesti√≥n de Locales</button>
                <button class="admin-tab-btn p-2 hover:bg-gray-200 rounded-t-lg font-medium border-b-2 border-transparent text-gray-600" data-tab="orders">Pedidos</button>
                <button class="admin-tab-btn p-2 hover:bg-gray-200 rounded-t-lg font-medium border-b-2 border-transparent text-gray-600" data-tab="motorizados">Motorizados</button>
                <button class="admin-tab-btn p-2 hover:bg-gray-200 rounded-t-lg font-medium border-b-2 border-transparent text-gray-600" data-tab="users">Usuarios/Staff</button>
            </div>

            <div id="admin-content">
                <div id="admin-stores" class="admin-tab-content">
                    <h3 class="text-2xl font-semibold mb-4">Locales</h3>
                    <!-- Formulario Add/Edit Store -->
                    <div class="bg-white p-6 card mb-6">
                        <input type="text" id="store-name" placeholder="Nombre del Local" class="input-field mb-2">
                        <input type="url" id="store-logo" placeholder="URL Logo (opcional)" class="input-field mb-2">
                        <input type="tel" id="store-whatsapp" placeholder="WhatsApp del Local (ej: 584121234567)" class="input-field mb-4">
                        <button class="btn-primary text-white py-2 px-4 rounded-lg mr-2" onclick="addStore()">Agregar Local</button>
                    </div>
                    <!-- Listado de Locales y Gesti√≥n de Productos -->
                    <div id="admin-stores-list" class="space-y-4"></div>
                </div>

                <div id="admin-orders" class="admin-tab-content hidden">
                    <h3 class="text-2xl font-semibold mb-4">Pedidos en Proceso</h3>
                    <div id="admin-orders-list" class="space-y-4"></div>
                    <h3 class="text-2xl font-semibold mt-8 mb-4">Historial de Pedidos (Completados/Cancelados)</h3>
                    <div id="admin-history-list" class="space-y-4"></div>
                </div>
                
                <div id="admin-motorizados" class="admin-tab-content hidden">
                    <h3 class="text-2xl font-semibold mb-4">Motorizados Activos</h3>
                    <!-- Formulario Add/Edit Motorizado -->
                    <div class="bg-white p-6 card mb-6">
                        <input type="text" id="moto-name" placeholder="Nombre" class="input-field mb-2">
                        <input type="text" id="moto-lastname" placeholder="Apellido" class="input-field mb-2">
                        <input type="tel" id="moto-phone" placeholder="Tel√©fono" class="input-field mb-2">
                        <input type="text" id="moto-cedula" placeholder="C√©dula" class="input-field mb-2">
                        <input type="text" id="moto-plate" placeholder="Placa de la Moto" class="input-field mb-2">
                        <input type="text" id="moto-model" placeholder="Modelo de la Moto" class="input-field mb-4">
                        <button class="btn-primary text-white py-2 px-4 rounded-lg" onclick="addMotorizado()">Agregar Motorizado</button>
                    </div>
                    <div id="admin-motorizados-list" class="space-y-4"></div>
                </div>
                
                <div id="admin-users" class="admin-tab-content hidden">
                    <h3 class="text-2xl font-semibold mb-4">Gesti√≥n de Roles (Soporte/Supervisores)</h3>
                    <div id="admin-users-list" class="space-y-4"></div>
                </div>
                
                <div id="admin-products-management" class="admin-tab-content hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-20">
                    <div class="bg-white p-6 card w-full max-w-lg">
                        <h3 class="text-2xl font-semibold mb-4 border-b pb-2">Gesti√≥n de Productos para <span id="current-store-name" class="text-primary"></span></h3>
                        
                        <!-- Formulario Add/Edit Product -->
                        <div class="mb-6 border p-4 rounded-lg">
                            <input type="text" id="product-name" placeholder="Nombre del Producto" class="input-field mb-2">
                            <input type="number" id="product-price" placeholder="Precio (Bs.)" step="0.01" class="input-field mb-2">
                            <input type="url" id="product-photo" placeholder="URL Foto del Producto (opcional)" class="input-field mb-4">
                            <button class="btn-primary text-white py-2 px-4 rounded-lg" onclick="addProduct()">Agregar Producto</button>
                        </div>
                        
                        <!-- Listado de Productos del Local -->
                        <div id="store-products-list" class="max-h-64 overflow-y-auto space-y-3"></div>

                        <button class="w-full bg-gray-500 text-white py-2 mt-6 rounded-lg" onclick="closeProductManagement()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- FOOTER - Muestra ID de Usuario y Login Admin -->
    <footer class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-2 text-xs flex justify-between items-center z-50">
        <span id="current-user-id" class="ml-2">Usuario: N/A (Cargando...)</span>
        
        <!-- Bot√≥n de Acceso Admin -->
        <button id="admin-login-btn" class="bg-primary text-white py-1 px-3 rounded-md hover:bg-red-700 transition" onclick="showAdminLoginModal()">
            Acceso Admin
        </button>
    </footer>

    <!-- Modal de Login Admin -->
    <div id="admin-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 card w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4">Acceso de Administrador</h3>
            <input type="text" id="admin-username" placeholder="Usuario (ej: Bambam)" class="input-field mb-4">
            <input type="password" id="admin-password" placeholder="Clave (ej: 27146006)" class="input-field mb-6">
            <button class="w-full btn-primary text-white py-2 font-semibold rounded-xl transition duration-150" onclick="handleAdminLogin()">
                Ingresar
            </button>
            <button class="w-full bg-gray-500 text-white py-2 mt-3 font-semibold rounded-xl transition duration-150" onclick="document.getElementById('admin-login-modal').classList.add('hidden')">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Scripts de Firebase y L√≥gica de la Aplicaci√≥n -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, 
            collection, query, where, getDocs, serverTimestamp, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

        // Enable debug logging for Firebase
        setLogLevel('debug');

        // --- FIREBASE CONFIGURATION & INITIALIZATION ---

        // Configuraci√≥n proporcionada por el usuario (usada como fallback si el entorno no las proporciona)
        const providedFirebaseConfig = {
            apiKey: "AIzaSyA9hjFmfNn1BnomqECKGr5YloU8LlM2OdM",
            authDomain: "bambamdelivery-626e6.firebaseapp.com",
            projectId: "bambamdelivery-626e6",
            storageBucket: "bambamdelivery-626e6.firebasestorage.app",
            messagingSenderId: "840361587686",
            appId: "1:840361587686:web:09326460bb14535b67dc27"
        };

        // Uso de variables globales del entorno (MANDATORIO) con fallback
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bambamdelivery-626e6';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : JSON.stringify(providedFirebaseConfig));
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let userRole = 'user';
        let isRegisterMode = false;
        let stores = [];
        let products = [];
        let motorizados = [];
        let orders = [];
        let currentStoreId = null;
        let cart = [];
        let currentView = 'home';
        
        const ADMIN_USERNAME = 'Bambam';
        const ADMIN_PASSWORD = '27146006';
        const WHATSAPP_VENEZUELA_CODE = '58'; // Para el bot√≥n de negocio

        // --- UTILITIES ---

        const messageBox = document.getElementById('app-message-box');
        const displayMessage = (text, type = 'error') => {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        };

        const hideMessage = () => messageBox.classList.add('hidden');

        const getStoreProducts = (storeId) => products.filter(p => p.storeId === storeId);

        const priceFormat = (price) => `Bs. ${parseFloat(price).toFixed(2)}`;

        // --- NAVIGATION & VIEW MANAGEMENT ---

        const navigate = (view) => {
            currentView = view;
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

            if (userRole === 'admin') {
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('cart-btn').classList.add('hidden');
                showAdminTab('stores');
                renderAdminUsers(); // Render users list on admin panel entry
            } else if (!auth.currentUser) {
                document.getElementById('auth-view').classList.remove('hidden');
                document.getElementById('cart-btn').classList.add('hidden');
            } else {
                document.getElementById('cart-btn').classList.remove('hidden');
                switch (view) {
                    case 'home':
                        document.getElementById('home-view').classList.remove('hidden');
                        renderStores();
                        break;
                    case 'menu':
                        document.getElementById('menu-view').classList.remove('hidden');
                        renderMenu();
                        break;
                    case 'cart':
                        document.getElementById('cart-view').classList.remove('hidden');
                        renderCart();
                        break;
                    default:
                        document.getElementById('home-view').classList.remove('hidden');
                        renderStores();
                }
            }
        };

        const updateUIState = () => {
            const user = auth.currentUser;
            const isLoggedIn = !!user;

            document.getElementById('logout-btn').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('admin-login-btn').classList.toggle('hidden', userRole === 'admin' || !isLoggedIn); // Hide if already admin

            if (user) {
                document.getElementById('current-user-id').textContent = `Usuario: ${user.email || user.uid}`;
            } else {
                document.getElementById('current-user-id').textContent = 'Usuario: Desconectado';
            }

            navigate(currentView);
        };

        // --- AUTHENTICATION ---

        const handleAuth = async () => {
            hideMessage();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;

            if (isRegisterMode) {
                // REGISTRATION
                const name = document.getElementById('reg-name').value;
                const lastname = document.getElementById('reg-lastname').value;
                const dob = document.getElementById('reg-dob').value;
                const phone = document.getElementById('reg-phone').value;

                if (!email || !password || !name || !lastname || !dob || !phone) {
                    return displayMessage("Error: Por favor, complete todos los campos de registro.");
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const userId = userCredential.user.uid;
                    
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                    await setDoc(userDocRef, { 
                        email: email, 
                        firstName: name, 
                        lastName: lastname, 
                        dob: dob, 
                        phone: phone, 
                        role: 'user', 
                        createdAt: serverTimestamp()
                    });
                    displayMessage("Registro exitoso. ¬°Bienvenido!", 'success');
                    isRegisterMode = false; // Vuelve a modo login
                    toggleAuthMode();
                } catch (error) {
                    console.error("Auth Error:", error);
                    displayMessage(`Error al registrar: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`);
                }
            } else {
                // LOGIN
                if (!email || !password) {
                    return displayMessage("Error: Por favor, ingrese correo y contrase√±a.");
                }
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    displayMessage("Inicio de sesi√≥n exitoso.", 'success');
                } catch (error) {
                    console.error("Auth Error:", error);
                    displayMessage(`Error al iniciar sesi√≥n: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`);
                }
            }
        };

        const toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').textContent = isRegisterMode ? 'Crear Cuenta (Registrar)' : 'Iniciar Sesi√≥n';
            document.getElementById('auth-btn').textContent = isRegisterMode ? 'Registrar Cuenta' : 'Iniciar Sesi√≥n';
            document.getElementById('toggle-register').textContent = isRegisterMode ? 'Ya tengo cuenta. Iniciar Sesi√≥n' : '¬øNo tienes cuenta? Reg√≠strate';
            document.getElementById('register-fields').classList.toggle('hidden', !isRegisterMode);
            hideMessage();
        };
        document.getElementById('toggle-register').addEventListener('click', (e) => { e.preventDefault(); toggleAuthMode(); });

        const signOutUser = async () => {
            try {
                await signOut(auth);
                userRole = 'user'; // Reset role on sign out
                currentView = 'home';
            } catch (error) {
                console.error("Logout Error:", error);
            }
        };

        // --- ADMIN LOGIN SIMULATION ---

        window.showAdminLoginModal = () => {
            document.getElementById('admin-login-modal').classList.remove('hidden');
        };

        window.handleAdminLogin = async () => {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            document.getElementById('admin-login-modal').classList.add('hidden');
            hideMessage();

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                if (!auth.currentUser) {
                    return displayMessage("Debe iniciar sesi√≥n primero con su cuenta de usuario para poder obtener el rol de administrador.", 'error');
                }

                const userId = auth.currentUser.uid;
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

                try {
                    // Update current user's role to admin
                    await updateDoc(userDocRef, { role: 'admin' });
                    displayMessage(`Acceso Admin concedido al usuario ${userId}.`, 'success');
                } catch (error) {
                    console.error("Error al asignar rol de admin:", error);
                    displayMessage("Error al actualizar el perfil para Admin. Revisa la consola.", 'error');
                }
            } else {
                displayMessage("Credenciales de administrador incorrectas.", 'error');
            }
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        };

        // --- FIREBASE LISTENERS (REALTIME DATA) ---

        // Listener para Locales
        const listenToStores = () => {
            const storesRef = collection(db, `artifacts/${appId}/public/data/stores`);
            onSnapshot(storesRef, (snapshot) => {
                stores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'home' && userRole === 'user') renderStores();
                if (userRole === 'admin') renderAdminStores();
            }, (error) => console.error("Error listening to stores:", error));
        };

        // Listener para Productos (Todos los productos)
        const listenToProducts = () => {
            const productsRef = collection(db, `artifacts/${appId}/public/data/products`);
            onSnapshot(productsRef, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'menu' && userRole === 'user') renderMenu();
            }, (error) => console.error("Error listening to products:", error));
        };

        // Listener para Motorizados
        const listenToMotorizados = () => {
            const motorizadosRef = collection(db, `artifacts/${appId}/public/data/motorizados`);
            onSnapshot(motorizadosRef, (snapshot) => {
                motorizados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (userRole === 'admin') renderAdminMotorizados();
            }, (error) => console.error("Error listening to motorizados:", error));
        };

        // Listener para Pedidos
        const listenToOrders = () => {
            const ordersRef = collection(db, `artifacts/${appId}/public/data/orders`);
            // Nota: Se elimina orderBy para evitar errores de √≠ndice y se ordena en JS
            onSnapshot(ordersRef, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (userRole === 'admin') renderAdminOrders();
            }, (error) => console.error("Error listening to orders:", error));
        };

        // --- USER VIEWS RENDERING ---

        const renderStores = () => {
            const container = document.getElementById('stores-list');
            container.innerHTML = stores.length === 0 
                ? '<p class="text-center col-span-full text-gray-500">No hay locales activos a√∫n. ¬°Reg√≠stra tu negocio!</p>'
                : stores.map(store => `
                <div class="card bg-white p-4 flex flex-col items-center text-center hover:shadow-lg transition cursor-pointer" onclick="viewMenu('${store.id}')">
                    <img src="${store.logoUrl || 'https://placehold.co/100x100/E3342F/white?text=Logo'}" class="w-24 h-24 rounded-full mb-3 object-cover" alt="Logo de ${store.name}">
                    <h3 class="text-lg font-semibold text-gray-800">${store.name}</h3>
                    <button class="text-primary text-sm mt-2 hover:underline">Ver Men√∫ &rarr;</button>
                </div>
            `).join('');
        };

        window.viewMenu = (storeId) => {
            currentStoreId = storeId;
            const store = stores.find(s => s.id === storeId);
            document.getElementById('menu-title').textContent = `Men√∫ de ${store.name}`;
            navigate('menu');
        };

        const renderMenu = () => {
            const container = document.getElementById('products-list');
            const menuProducts = getStoreProducts(currentStoreId);

            container.innerHTML = menuProducts.length === 0
                ? '<p class="text-center col-span-full text-gray-500">Este local no tiene productos activos a√∫n.</p>'
                : menuProducts.map(product => `
                <div class="card bg-white p-4 flex flex-col">
                    <img src="${product.photoUrl || 'https://placehold.co/300x200/F6AD55/white?text=Producto'}" class="w-full h-32 object-cover rounded-md mb-3" alt="Foto de ${product.name}">
                    <h3 class="text-lg font-semibold text-gray-800">${product.name}</h3>
                    <p class="text-2xl font-bold text-primary my-1">${priceFormat(product.price)}</p>
                    <button class="w-full btn-primary text-white py-2 rounded-lg mt-auto" onclick="addToCart('${product.id}', '${product.name}', ${product.price})">
                        A√±adir al Carrito
                    </button>
                </div>
            `).join('');
        };

        // --- CART LOGIC ---
        
        const updateCartCount = () => {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = count;
            document.getElementById('cart-btn').classList.toggle('hidden', count === 0);
        };

        window.addToCart = (productId, name, price) => {
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ productId, name, price, quantity: 1, observations: '' });
            }
            updateCartCount();
            displayMessage(`${name} a√±adido al carrito.`, 'success');
        };

        const updateCartItemQuantity = (index, delta) => {
            const item = cart[index];
            item.quantity += delta;
            if (item.quantity <= 0) {
                cart.splice(index, 1);
            }
            updateCartCount();
            renderCart();
        };

        const updateCartItemObservation = (index, observation) => {
            cart[index].observations = observation;
        };

        const renderCart = () => {
            const container = document.getElementById('cart-items-container');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cart-total-price').textContent = priceFormat(total);
            document.getElementById('empty-cart-message').classList.toggle('hidden', cart.length > 0);

            container.innerHTML = cart.map((item, index) => `
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 mb-4">
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${item.name}</p>
                        <p class="text-primary font-semibold">${priceFormat(item.price)} x ${item.quantity}</p>
                        <textarea onchange="updateCartItemObservation(${index}, this.value)" class="w-full p-2 border rounded-md mt-2 text-sm" rows="1" placeholder="Observaciones (ej: sin tomate)">${item.observations}</textarea>
                    </div>
                    <div class="flex items-center space-x-2 mt-3 md:mt-0">
                        <button class="bg-gray-200 p-1.5 rounded-full w-8 h-8 flex items-center justify-center text-xl" onclick="updateCartItemQuantity(${index}, -1)">-</button>
                        <span class="font-medium w-4 text-center">${item.quantity}</span>
                        <button class="bg-gray-200 p-1.5 rounded-full w-8 h-8 flex items-center justify-center text-xl" onclick="updateCartItemQuantity(${index}, 1)">+</button>
                    </div>
                </div>
            `).join('') + (cart.length > 0 ? '' : document.getElementById('empty-cart-message').outerHTML);

            // Re-hide the empty message if items were added
            if (cart.length > 0) document.getElementById('empty-cart-message').classList.add('hidden');
        };

        window.placeOrder = async () => {
            if (cart.length === 0) return displayMessage("El carrito est√° vac√≠o.", 'error');

            const firstName = document.getElementById('checkout-name').value;
            const lastName = document.getElementById('checkout-lastname').value;
            const address = document.getElementById('checkout-address').value;
            const phone = document.getElementById('checkout-phone').value;

            if (!firstName || !lastName || !address || !phone) {
                return displayMessage("Por favor, complete todos los campos de detalles de entrega.", 'error');
            }

            const store = stores.find(s => s.id === currentStoreId);
            if (!store || !store.whatsapp) {
                return displayMessage("Error: El local seleccionado no tiene un n√∫mero de WhatsApp configurado.", 'error');
            }

            const orderTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderItems = cart.map(item => ({
                name: item.name,
                qty: item.quantity,
                price: item.price,
                obs: item.observations
            }));

            // 1. Guardar Pedido en Firestore
            try {
                const orderRef = await addDoc(collection(db, `artifacts/${appId}/public/data/orders`), {
                    userId: auth.currentUser.uid,
                    storeId: store.id,
                    storeName: store.name,
                    items: JSON.stringify(orderItems), // Almacenar como string para compatibilidad de Firestore
                    total: orderTotal,
                    status: 'pending',
                    customerDetails: { firstName, lastName, address, phone },
                    timestamp: serverTimestamp()
                });

                // 2. Generar Mensaje de WhatsApp
                let whatsappMessage = `*¬°Tienes un nuevo pedido de Bambam delivery delivery!* (ID: ${orderRef.id})\n\n`;
                whatsappMessage += `*Cliente:* ${firstName} ${lastName}\n`;
                whatsappMessage += `*Tel√©fono:* ${phone}\n`;
                whatsappMessage += `*Direcci√≥n:* ${address}\n\n`;
                whatsappMessage += `*--- Detalles del Pedido ---*\n`;
                
                orderItems.forEach(item => {
                    whatsappMessage += `${item.qty} x ${item.name} (${priceFormat(item.price)}) - Total: ${priceFormat(item.qty * item.price)}\n`;
                    if (item.obs) whatsappMessage += `  (Obs: ${item.obs})\n`;
                });

                whatsappMessage += `\n*TOTAL FINAL:* ${priceFormat(orderTotal)}`;
                whatsappMessage += `\n\n_Importante: La ubicaci√≥n GPS debe ser enviada a este chat._`;

                const whatsappUrl = `https://wa.me/${store.whatsapp}?text=${encodeURIComponent(whatsappMessage)}`;

                // 3. Limpiar Carrito y Mostrar Mensaje
                cart = [];
                updateCartCount();
                navigate('home');
                displayMessage("Pedido realizado con √©xito. ¬°Ser√°s redirigido a WhatsApp!", 'success');

                // 4. Redirigir y Mostrar Instrucci√≥n (usando un peque√±o timeout para que el mensaje de √©xito se vea)
                setTimeout(() => {
                    window.open(whatsappUrl, '_blank');
                    displayMessage(`¬°PEDIDO ENVIADO! Por favor, env√≠e su ubicaci√≥n actual por GPS a ${store.name} a trav√©s de WhatsApp.`, 'success');
                }, 1500);


            } catch (error) {
                console.error("Error al realizar pedido:", error);
                displayMessage("Error al procesar el pedido. Intente de nuevo.", 'error');
            }
        };


        // --- ADMIN VIEW RENDERING AND CRUD ---

        const showAdminTab = (tabName) => {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-${tabName}`).classList.remove('hidden');
            
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary', 'font-bold');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-primary', 'text-primary', 'font-bold');
                }
            });

            // Trigger rendering for lists
            if (tabName === 'stores') renderAdminStores();
            if (tabName === 'orders') renderAdminOrders();
            if (tabName === 'motorizados') renderAdminMotorizados();
            if (tabName === 'users') renderAdminUsers();
        };

        document.querySelectorAll('.admin-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => showAdminTab(btn.dataset.tab));
        });

        // --- STORES CRUD ---

        window.addStore = async () => {
            const name = document.getElementById('store-name').value;
            const logoUrl = document.getElementById('store-logo').value;
            const whatsapp = document.getElementById('store-whatsapp').value;

            if (!name || !whatsapp) {
                return displayMessage("Nombre y WhatsApp del local son requeridos.", 'error');
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/stores`), {
                    name,
                    logoUrl,
                    whatsapp: whatsapp.replace(/[^0-9]/g, ''), // Asegura solo n√∫meros
                    active: true,
                    createdAt: serverTimestamp()
                });
                document.getElementById('store-name').value = '';
                document.getElementById('store-logo').value = '';
                document.getElementById('store-whatsapp').value = '';
                displayMessage("Local agregado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al agregar local:", error);
                displayMessage("Error al guardar el local.", 'error');
            }
        };

        window.deleteStore = async (storeId) => {
            try {
                // Tambi√©n se deber√≠an eliminar productos relacionados, pero por simplicidad solo se elimina el local
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/stores`, storeId));
                displayMessage("Local eliminado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al eliminar local:", error);
                displayMessage("Error al eliminar local.", 'error');
            }
        };

        const renderAdminStores = () => {
            const container = document.getElementById('admin-stores-list');
            container.innerHTML = stores.length === 0 
                ? '<p class="text-center col-span-full text-gray-500">No hay locales registrados.</p>'
                : stores.map(store => `
                <div class="bg-white p-4 card flex justify-between items-center">
                    <div class="flex-grow">
                        <p class="font-bold text-lg">${store.name}</p>
                        <p class="text-sm text-gray-600">WhatsApp: ${store.whatsapp}</p>
                    </div>
                    <div>
                        <button class="bg-secondary text-gray-800 py-1 px-3 rounded-md mr-2" onclick="showProductManagement('${store.id}', '${store.name}')">Productos</button>
                        <button class="bg-red-500 text-white py-1 px-3 rounded-md" onclick="deleteStore('${store.id}')">Eliminar</button>
                    </div>
                </div>
            `).join('');
        };
        
        // --- PRODUCTS CRUD (Management Modal) ---
        let productStoreId = null;

        window.showProductManagement = (storeId, storeName) => {
            productStoreId = storeId;
            document.getElementById('current-store-name').textContent = storeName;
            document.getElementById('admin-products-management').classList.remove('hidden');
            renderStoreProducts();
        };

        window.closeProductManagement = () => {
            document.getElementById('admin-products-management').classList.add('hidden');
            productStoreId = null;
            document.getElementById('product-name').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-photo').value = '';
        };

        window.addProduct = async () => {
            const name = document.getElementById('product-name').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const photoUrl = document.getElementById('product-photo').value;

            if (!name || isNaN(price) || !productStoreId) {
                return displayMessage("Nombre y Precio del producto son requeridos.", 'error');
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/products`), {
                    storeId: productStoreId,
                    name,
                    price,
                    photoUrl,
                    createdAt: serverTimestamp()
                });
                document.getElementById('product-name').value = '';
                document.getElementById('product-price').value = '';
                document.getElementById('product-photo').value = '';
                displayMessage("Producto agregado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al agregar producto:", error);
                displayMessage("Error al guardar el producto.", 'error');
            }
        };

        window.deleteProduct = async (productId) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/products`, productId));
                displayMessage("Producto eliminado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al eliminar producto:", error);
                displayMessage("Error al eliminar producto.", 'error');
            }
        };

        const renderStoreProducts = () => {
            if (!productStoreId) return;
            const container = document.getElementById('store-products-list');
            const storeProducts = getStoreProducts(productStoreId);

            container.innerHTML = storeProducts.length === 0
                ? '<p class="text-center text-gray-500">No hay productos para este local.</p>'
                : storeProducts.map(product => `
                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center">
                    <p class="font-medium flex-grow">${product.name} - ${priceFormat(product.price)}</p>
                    <button class="bg-red-500 text-white py-1 px-3 rounded-md text-sm" onclick="deleteProduct('${product.id}')">Eliminar</button>
                </div>
            `).join('');
        };


        // --- ORDERS MANAGEMENT ---

        const updateOrderStatus = async (orderId, newStatus) => {
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, orderId), { status: newStatus });
                displayMessage(`Pedido ${orderId} marcado como ${newStatus}.`, 'success');
            } catch (error) {
                console.error("Error al actualizar pedido:", error);
                displayMessage("Error al actualizar estado del pedido.", 'error');
            }
        };

        const renderAdminOrders = () => {
            // Sort by timestamp (newest first)
            const sortedOrders = [...orders].sort((a, b) => b.timestamp?.seconds - a.timestamp?.seconds);

            const pendingOrders = sortedOrders.filter(o => o.status === 'pending' || o.status === 'in-process');
            const historyOrders = sortedOrders.filter(o => o.status === 'delivered' || o.status === 'cancelled');

            const renderOrderList = (list, containerId) => {
                const container = document.getElementById(containerId);
                container.innerHTML = list.length === 0
                    ? `<p class="text-center text-gray-500">No hay pedidos en esta secci√≥n.</p>`
                    : list.map(order => {
                        const items = JSON.parse(order.items || '[]');
                        const details = order.customerDetails || {};
                        const statusColor = order.status === 'delivered' ? 'bg-green-100 text-green-700' : (order.status === 'cancelled' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700');

                        return `
                        <div class="bg-white p-4 card">
                            <div class="flex justify-between items-start border-b pb-2 mb-2">
                                <div>
                                    <p class="font-bold text-lg">${order.storeName}</p>
                                    <p class="text-xs text-gray-500">ID: ${order.id}</p>
                                </div>
                                <span class="${statusColor} text-xs font-semibold px-3 py-1 rounded-full">${order.status.toUpperCase()}</span>
                            </div>
                            <p class="font-medium">Total: ${priceFormat(order.total)}</p>
                            <p class="text-sm">Cliente: ${details.firstName} ${details.lastName} (${details.phone})</p>
                            <p class="text-sm mb-2">Entrega: ${details.address}</p>
                            
                            <ul class="list-disc list-inside text-xs ml-2 mb-3 bg-gray-50 p-2 rounded-md">
                                ${items.map(item => `<li>${item.qty}x ${item.name} (${item.obs || 'Sin Obs.'})</li>`).join('')}
                            </ul>

                            <div class="flex space-x-2">
                                ${order.status !== 'delivered' ? `<button class="bg-green-500 text-white py-1 px-2 rounded-md text-sm" onclick="updateOrderStatus('${order.id}', 'delivered')">Entregado</button>` : ''}
                                ${order.status !== 'cancelled' ? `<button class="bg-red-500 text-white py-1 px-2 rounded-md text-sm" onclick="updateOrderStatus('${order.id}', 'cancelled')">Cancelado</button>` : ''}
                            </div>
                        </div>
                        `;
                    }).join('');
            };

            renderOrderList(pendingOrders, 'admin-orders-list');
            renderOrderList(historyOrders, 'admin-history-list');
        };

        // --- MOTORIZADOS MANAGEMENT ---

        window.addMotorizado = async () => {
            const name = document.getElementById('moto-name').value;
            const lastname = document.getElementById('moto-lastname').value;
            const phone = document.getElementById('moto-phone').value;
            const cedula = document.getElementById('moto-cedula').value;
            const plate = document.getElementById('moto-plate').value;
            const model = document.getElementById('moto-model').value;

            if (!name || !phone || !plate) {
                return displayMessage("Nombre, Tel√©fono y Placa son requeridos.", 'error');
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/motorizados`), {
                    name, lastname, phone, cedula, plate, model,
                    createdAt: serverTimestamp()
                });
                document.getElementById('moto-name').value = '';
                document.getElementById('moto-lastname').value = '';
                document.getElementById('moto-phone').value = '';
                document.getElementById('moto-cedula').value = '';
                document.getElementById('moto-plate').value = '';
                document.getElementById('moto-model').value = '';
                displayMessage("Motorizado agregado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al agregar motorizado:", error);
                displayMessage("Error al guardar el motorizado.", 'error');
            }
        };

        window.deleteMotorizado = async (motorizadoId) => {
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/motorizados`, motorizadoId));
                displayMessage("Motorizado eliminado con √©xito.", 'success');
            } catch (error) {
                console.error("Error al eliminar motorizado:", error);
                displayMessage("Error al eliminar motorizado.", 'error');
            }
        };

        const renderAdminMotorizados = () => {
            const container = document.getElementById('admin-motorizados-list');
            container.innerHTML = motorizados.length === 0
                ? '<p class="text-center text-gray-500">No hay motorizados registrados.</p>'
                : motorizados.map(moto => `
                <div class="bg-white p-4 card flex justify-between items-center">
                    <div class="flex-grow">
                        <p class="font-bold">${moto.name} ${moto.lastname}</p>
                        <p class="text-sm text-gray-600">Tel: ${moto.phone} | Placa: ${moto.plate} (${moto.model})</p>
                    </div>
                    <button class="bg-red-500 text-white py-1 px-3 rounded-md text-sm" onclick="deleteMotorizado('${moto.id}')">Eliminar</button>
                </div>
            `).join('');
        };

        // --- USER/STAFF MANAGEMENT ---

        const renderAdminUsers = async () => {
            const container = document.getElementById('admin-users-list');
            
            // Get all users profiles
            const usersRef = collection(db, `artifacts/${appId}/users`);
            const usersSnapshot = await getDocs(usersRef);
            
            const userProfiles = [];
            for (const userDoc of usersSnapshot.docs) {
                const profileSnap = await getDocs(collection(db, `artifacts/${appId}/users/${userDoc.id}/profile`));
                if (!profileSnap.empty) {
                    const profileData = profileSnap.docs[0].data();
                    userProfiles.push({ uid: userDoc.id, ...profileData });
                } else {
                    userProfiles.push({ uid: userDoc.id, email: 'N/A', role: 'user' });
                }
            }

            container.innerHTML = userProfiles.length === 0
                ? '<p class="text-center text-gray-500">No hay usuarios registrados.</p>'
                : userProfiles.map(user => `
                <div class="bg-white p-4 card flex justify-between items-center">
                    <div class="flex-grow">
                        <p class="font-bold">${user.firstName || user.email}</p>
                        <p class="text-sm text-gray-600">ID: ${user.uid.substring(0, 10)}... | Rol: <span class="font-semibold">${user.role.toUpperCase()}</span></p>
                    </div>
                    <select onchange="updateUserRole('${user.uid}', this.value)" class="p-1 border rounded-md text-sm">
                        <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuario</option>
                        <option value="support" ${user.role === 'support' ? 'selected' : ''}>Soporte</option>
                        <option value="supervisor" ${user.role === 'supervisor' ? 'selected' : ''}>Supervisor</option>
                        <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </div>
            `).join('');
        };

        window.updateUserRole = async (userId, newRole) => {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
                await updateDoc(userDocRef, { role: newRole });
                displayMessage(`Rol de usuario ${userId.substring(0, 5)}... actualizado a ${newRole}.`, 'success');
            } catch (error) {
                console.error("Error al actualizar rol:", error);
                displayMessage("Error al actualizar el rol de usuario.", 'error');
            }
        };

        // --- AUTH STATE AND INITIALIZATION ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Fetch user profile and role
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile/data`);
                
                // Set up listener for user role
                onSnapshot(userDocRef, (docSnap) => {
                    const data = docSnap.data();
                    userRole = data?.role || 'user';
                    updateUIState();
                }, (error) => {
                    // Fallback if profile doesn't exist yet (e.g., anonymous sign-in)
                    userRole = 'user';
                    updateUIState();
                    console.warn("Could not read user profile/role. Assuming 'user'.", error);
                });
                
            } else {
                userRole = 'user';
                updateUIState();
            }
        });

        // Mandatory custom token sign-in logic for Canvas environment
        const authenticate = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if the custom token is not available
                    await signInAnonymously(auth);
                }
                listenToStores();
                listenToProducts();
                listenToMotorizados();
                listenToOrders();
            } catch (error) {
                console.error("Initial Authentication Error:", error);
                displayMessage(`Error al iniciar sesi√≥n: ${error.message.replace('Firebase: Error (auth/', '').replace(').', '')}`);
            }
        };

        // Start the application
        authenticate();
        // Set initial view
        navigate('home'); 

    </script>
</body>
</html>